include snippets/geoblock.conf;

server {
	listen 80;
        listen [::]:80;
	listen localhost:443 ssl http2;
        listen [::]:443 ssl http2;
        
	server_name git.ffhl git.luebeck.freifunk.net git.ffhl.de;
	
	# TLS
	include snippets/acme.conf;
	include snippets/tls.conf;
	ssl_certificate /var/lib/acme/live/www.luebeck.freifunk.net/fullchain;
        ssl_certificate_key /var/lib/acme/live/www.luebeck.freifunk.net/privkey;	

	if ($ssl_protocol = "") {
		# force TLS
		return 301 https://$host$request_uri;
	}
	
	
	client_max_body_size 256M;
	
	# apply geoblocking
	if ($allowed_country = no) {
		return 302 https://luebeck.freifunk.net/;
	}

        location / {
                proxy_set_header Host $host;
                proxy_pass http://localhost:3001/;
                proxy_connect_timeout       300;
                proxy_send_timeout          300;
                proxy_read_timeout          300;
                send_timeout                300;
        }
}

