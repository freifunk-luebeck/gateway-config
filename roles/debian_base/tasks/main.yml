---
-
- include: software.yml

- name: Disable root login with password
  lineinfile: dest=/etc/ssh/sshd_config regexp="^#?PermitRootLogin" line="PermitRootLogin without-password"

- name: copy base configs
  copy: src=etc/ dest=/etc
  tags: [bird, fastd]

- name: copy host specific configs
  copy: src=host/{{ inventory_hostname }}/etc/ dest=/etc
  tags: [bird, fastd]

- name: copy scripts
  copy: src=scripts/iptables-up dest=/usr/local/bin/iptables-up mode=755



# configurations and stuff

- name: set local timezone
  file: state=link src=/usr/share/zoneinfo/Europe/Berlin dest=/etc/localtime

- name: configure ntp
  blockinfile:
    path: /etc/ntp.conf
    block: |
      restrict fdef:ffc0:3dd7:: mask ffff:ffff:ffff:ffff:: nomodify notrap nopeer
      restrict 2001:67c:2d50:: mask ffff:ffff:ffff:ffff:: nomodify notrap nopeer


- name: networkd templates
  block:
    - template: src=network/10-ffhl.netdev.j2 dest=/etc/systemd/network/10-ffhl.netdev
    - template: src=network/12-ffhl.network.j2 dest=/etc/systemd/network/12-ffhl.network

- name: template iptables
  block:
    - template: src=iptables/rules.v4 dest=/etc/iptables/rules.v4
    # - template: src=iptables/rules.v6 dest=/etc/iptables/rules.v6


# sometimes disabled (dunno why)
- name: enable systemd-networkd
  command: systemctl enable systemd-networkd

- name: restart systemd-networkd
  systemd:
    state: restarted
    name: systemd-networkd


- name: create fastd configs
  include_tasks: fastd.yml
  loop:
    - ffhl_mesh_vpn
    - ffhl_mesh_gwvpn


- name: reload systemd
  command: systemctl daemon-reload


- include: radvd.yml
- include: dhcpd.yml

- lineinfile: dest=/etc/iproute2/rt_tables line="42\tfreifunk"

- include: bird.yml
  tags:
    - bird


- include: ffhl-dns.yml
- include: ffhl-peers.yml
- include: units.yml
