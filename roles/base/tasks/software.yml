---
- name: install python3-apt
  shell:
    cmd: apt-get install -y python3-apt
    warn: no


- name: add appropriate source.list
  tags: [apt]
  block:
  - name: add apt preferences
    copy:
      src: apt/preferences.d
      dest: /etc/apt/
  - name: add source list for debian buster
    when: '"buster" in ansible_facts["lsb"]["description"]'
    copy:
      src: apt/debian_buster.list
      dest: /etc/apt/sources.list
  - name: add source list for debian bullseye
    when: "'bullseye' in ansible_facts['lsb']['description']"
    copy:
      src: apt/debian_bullseye.list
      dest: /etc/apt/sources.list



- name: remove packages that are not needed
  apt:
    update_cache: yes
    state: absent
    name:
      - cron-apt
      - mutt
      - rsyslog

- name: install tools
  apt:
    autoremove: yes
    update_cache: yes
    state: present
    name:
      # necessary packets
      - batctl
      - fastd
      - git
      - haveged
      - iproute2
      - iptables-persistent
      - isc-dhcp-server
      - openssh-server
      - prometheus-node-exporter
      - radvd
      # - systemd-timesyncd causes dependency hell atm
      # tools
      - screenfetch
      - apt-file
      - bridge-utils
      - curl
      - dnsutils
      - htop
      - iftop
      - iperf3
      - iputils-ping
      - jq
      - molly-guard
      - openssh-client
      - python3-yaml
      - socat
      - tcpdump
      - vim
      - wget
      - rsync
      - nmap

- name: load batman-adv
  modprobe:
    name: batman-adv
    state: present


# install prometheus-fastd-exporter
- name: install prometheus-fastd-exporter
  tags: [prometheus-fastd-exporter, fastd]
  block:
  - name: download prometheus-fastd-exporter
    get_url:
      url: https://freifunk-luebeck.pages.chaotikum.org/prometheus-fastd-exporter/prometheus-fastd-exporter.deb
      dest: /tmp/prometheus-fastd-exporter.deb

  - name: install prometheus-fastd-exporter
    command: dpkg -i --force-confold /tmp/prometheus-fastd-exporter.deb

  - name: enable prometheus-fastd-exporter
    systemd:
      daemon_reload: yes
      state: restarted
      enabled: yes
      name: prometheus-fastd-exporter
